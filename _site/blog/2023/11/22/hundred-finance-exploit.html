<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Hundred Finance Exploit</title>
  <meta name="description" content="A blog post explaining about hundred web3 finance exploit.">

  <!-- Social: Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@0xVijayReddy">
  <meta name="twitter:title" content="Hundred Finance Exploit">
  <meta name="twitter:description" content="A blog post explaining about hundred web3 finance exploit.">
  
  <meta property="twitter:image:src" content="/assets/img/opengraph.png">
  

  <!-- Social: Facebook / Open Graph -->
  <meta property="og:url" content="/blog/2023/11/22/hundred-finance-exploit.html">
  <meta property="og:title" content="Hundred Finance Exploit">
  
  <meta property="og:image" content="/assets/img/opengraph.png">
  
  <meta property="og:description" content="A blog post explaining about hundred web3 finance exploit.">
  <meta property="og:site_name" content="jekyll-theme-potato-hacker">

  <!-- Social: Schema.org  -->
  <meta itemprop="name" content="Hundred Finance Exploit"/>
  <meta itemprop="description" content="A blog post explaining about hundred web3 finance exploit.">
  <meta itemprop="image" content="/assets/img/opengraph.png"/>

  <!-- Favicon -->
  <link rel="shortcut icon" href="/assets/img/icons/favicon.ico" type="image/x-icon" />

  <!-- Android Lolipop Theme Color -->
  <meta name="theme-color" content="#2a4d14">

  <!-- Styles -->
  <link rel="stylesheet" id="css-theme" href="/assets/css/main-dark.css">
  <link rel="stylesheet" href="/assets/css/highlight/gruvbox.css">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet">

  <!-- Javascript -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.3.0/d3.min.js"></script>
  <script type="text/javascript" src="/assets/js/main.js"></script>
</head>


<body class="animated fadeIn">
  <div class="container">
    <div id="background-div">
      <svg id="background-svg">
        <lineargradient id="Gradient1" x1="0" x2="0" y1="0" y2="1">
          <stop stop-opacity="0" class="bgColor2" offset="0%" />
          <stop stop-opacity="0.5" class="bgColor2" offset="10%" />
          <stop stop-opacity="0.5" class="bgColor1" offset="40%" />
          <stop stop-opacity="0" class="bgColor1" offset="100%" />
        </lineargradient>
        <g id="bg-layer1"></g>
        <g id="bg-layer2" class="hide"></g>
        <g id="bg-layer3"></g>
        <g id="bg-layer4"></g>
      </svg>
    </div>
    <section class="header">
      <header>
  <div class="row">
    <div class="col-xs-12">
      <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
          <div class="navbar-header">
            <a class="navbar-toggle collapsed navbar-icon" data-toggle="collapse"
              data-target="#bs-example-navbar-collapse-1">
              <i class="fa fa-bars fa-2x"></i>
            </a>
            <a class="navbar-brand navbar-icon" href="/">
                <i class="fa fa-home fa-2x"></i>
            </a>
          </div>

          <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
              <li><a href="/">Home</a></li>
              
                <li><a href="/blog">Blog</a></li>
              

              
              
                <li class="nav-item"><a href="/items/about.html">About</a></li>
              

              <script>
                // clean repeated dropdowns and add <li> to their positions
                let done = [];
                let elements = [];
                $(".dropdown")
                  //
                  .each((index0 , value0) => {
                    let dropdownClass = "."+$(value0)[0].classList[1];
                    if (done.indexOf(dropdownClass) !== -1) return
                    done.push(dropdownClass)
                    let dropdownMain = $(dropdownClass)[0]
                    let itemsList = $(dropdownClass+">ul>li").sort((a, b) => parseInt(b.getAttribute("priority") || -9999999) - parseInt(a.getAttribute("priority") || -9999999))
                    $(dropdownClass+">ul>li").remove();
                    $(dropdownClass+">ul").append(itemsList)
                    $(dropdownClass).remove();
                    elements.push(dropdownMain)
                });
                let priority = [ "About", ];
                elements = elements.concat(...$(".nav-item").remove())
                priority.map(text => {
                  elements = elements.filter(node => {
                      let nodeText = node.querySelector("a").textContent.trim()
                      if (text == nodeText) {
                          $(".nav").append(node)
                          return false;
                      }
                      return true;
                  })
                });
                $(".nav").append(elements)
              </script>
            </ul>
          </div>
        </div>
      </nav>
    </div>
  </div>
</header>

    </section>
    <section class="content">
      <div class="row">
        <!-- <div class="col-sm-2">
          <div class="pane-separator hidden-xs" style="margin-bottom:30em;"></div>
          <div class="left-pane">
          </div>
        </div> -->
        <div class="col-sm-8 col-sm-offset-2 content-div">
          <div class="page-separator hidden-xs">
            <h1 class="h1-strip" style="padding-bottom:8em; margin-bottom: 0;"></h1>
          </div>
          <div class="page-separator visible-xs">
            <h1 class="h1-strip" style="padding-bottom:2em; margin-bottom: 0;"></h1>
          </div>
          <h1 class="post-title page-title" id="title"><a href="#title">Hundred Finance Exploit</a></h1>
          <h4 class="post-title"> 2023-11-22 19:37:12 +0530 </h4>
<article class="blog-post">
  <p>In this blog post, I explain how Hundred Finance lost $7 million due to a simple rounding error.
<!--more--></p>

<p><br /></p>

<p><img src="https://images.unsplash.com/photo-1563206767-5b18f218e8de?q=80&amp;w=2938&amp;auto=format&amp;fit=crop&amp;ixlib=rb-4.0.3&amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="faf" /></p>

<p><br /></p>

<p>On April 15, Hundred Finance was drained by an attacker due to a rounding error in its <code class="language-plaintext highlighter-rouge">redeemUnderlying</code> function. However, this rounding error can only be exploited if there is a market with zero liquidity. Unfortunately, Hundred Finance created two WBTC markets, one of which was used by the UI, but the other market was empty with zero liquidity.</p>

<p>This attack is similar to the well-known ERC4626 first-depositor inflation attack.</p>

<p>First of all, why should we care about this attack?</p>

<p>Because Hundred Finance is a fork of Compound V2, and this attacker vector is in the Compound V2 codebase itself, which is one of the most forked codebases in the DeFi space. So to prevent further exploits on Compound V2 forks, every developer and security researcher should be aware of this issue.</p>

<p>Before diving into the issue, let’s understand how Compound V2 works at a high level.</p>

<p><br /></p>

<h2 id="compound-v2">Compound V2</h2>

<p>Compound is an over-collateralized lending protocol where lenders can supply liquidity to a market, and borrowers can borrow funds by providing a different type of asset as collateral. Borrowers will pay interest for the funds they borrow, which will be distributed to lenders based on the amount of liquidity they supplied to the market.</p>

<p>For every asset, there will be a market, and shares (cTokens) for that market will be minted when a user supplies assets to that market based on the current exchange rate.</p>

<p>Whenever we supply assets to a market, we get borrowing power to borrow funds from a different market.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>deposit WBTC ---&gt; mint shares     
redeem  WBTC ---&gt; burn shares

borrowing power = shares * exchangeRate
exchangeRate    = how much WBTC each share is worth
</code></pre></div></div>

<p><br /></p>

<h2 id="root-cause">Root cause</h2>

<p>The root cause of the attack is a rounding issue in the <code class="language-plaintext highlighter-rouge">redeemUnderlying</code> function. Whenever a user redeems their underlying tokens (WBTC in this case), the number of shares to burn is calculated as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>shares to burn = underlying token amount / exchangeRate
</code></pre></div></div>
<p><br /></p>

<p>But instead of rounding up, the number of shares to burn is rounded down in <code class="language-plaintext highlighter-rouge">redeemUnderlying</code> function. Due to this, in some cases, one wei fewer number of shares will be burned. At first glance, this doesn’t seem like an issue because, after all, it’s just one wei of share. In a normal market, this one wei of share isn’t even worth one cent. But what if that one wei of share is worth 250 bitcoins? Exactly, that’s what happened in the Hundread Finance attack. The attacker was able to amplify this small rounding error by inflating the exchange rate to 250 bitcoins.</p>

<p><br /></p>

<h2 id="redemption-process">Redemption process</h2>

<ol>
  <li>Calculate the exchangeRate of the market.</li>
  <li>Calculate the sum of assets borrowed by the user in all markets (active loan value).</li>
  <li>Make sure that the user’s remaining collateral value(value after redemption) covers the active loan value.
    <ul>
      <li>If the remaining collateral covers the active loan, allow redemption.</li>
      <li>If the remainging collateral doesn’t cover the active loan value, revert the transaction.</li>
    </ul>
  </li>
</ol>

<p><br /></p>

<h2 id="the-attack">The Attack</h2>

<ol>
  <li>First the attacker get a 500 WBTC flashloan from AAVE.</li>
  <li>
    <p>Then attacker uses a small portion of his WBTC to mint hWBTC(shares), before redeeming all but 0.00000002 (2 wei).</p>

    <table>
      <thead>
        <tr>
          <th>State</th>
          <th>Before</th>
          <th>After</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">Attacker shares</code></td>
          <td>0 wei</td>
          <td>2 wei</td>
        </tr>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">Attacker collateral</code></td>
          <td>0 wei</td>
          <td>1 wei</td>
        </tr>
      </tbody>
    </table>

    <p><br />
 <img class="img img-responsive" alt="pong-almost-from-scratch" height="600" width="500" style="display: block; margin: 0 auto;" src="/assets/img/h1.png" />
 <br /></p>
  </li>
  <li>
    <p>Then the attacker donated 500 WBTC to the protocol by doing a direct transfer to inflate the exchangeRate to 250 WBTC/ 1 Wei hWBTC.</p>

    <table>
      <thead>
        <tr>
          <th>State</th>
          <th>Before</th>
          <th>After</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">Attacker shares</code></td>
          <td>2 Wei</td>
          <td>2 Wei</td>
        </tr>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">Attacker collateral</code></td>
          <td>0.00000001 WBTC</td>
          <td>500.00000001 WBTC</td>
        </tr>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">Exchange Rate</code></td>
          <td>0 WBTC / 1 wei hWBTC</td>
          <td>250 WBTC / 1 wei hWBTC</td>
        </tr>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">Loan Value</code></td>
          <td>0 WBTC</td>
          <td>0 WBTC</td>
        </tr>
      </tbody>
    </table>

    <p><br />
 <img class="img img-responsive" alt="pong-almost-from-scratch" height="600" width="500" style="display: block; margin: 0 auto" src="/assets/img/h2.png" /></p>

    <p><br /></p>
  </li>
  <li>
    <p>Now the attacker borrowed 70 WBTC worth of ETH from ETH market.</p>

    <table>
      <thead>
        <tr>
          <th>State</th>
          <th>Before</th>
          <th>After</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">Attacker shares</code></td>
          <td>2 Wei</td>
          <td>2 Wei</td>
        </tr>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">Attacker collateral</code></td>
          <td>500.00000001 WBTC</td>
          <td>500.00000001 WBTC</td>
        </tr>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">Exchange Rate</code></td>
          <td>250 WBTC / 1 Wei hWBTC</td>
          <td>250 WBTC / 1 Wei hWBTC</td>
        </tr>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">Loan Value</code></td>
          <td>0  WBTC</td>
          <td>70  WBTC</td>
        </tr>
      </tbody>
    </table>

    <p><br />
 <img class="img img-responsive" alt="pong-almost-from-scratch" height="600" width="500" style="display: block; margin: 0 auto" src="/assets/img/h3.png" />
 <br /></p>
  </li>
  <li>
    <p>Then the attacker redeemed <code class="language-plaintext highlighter-rouge">499.99999999</code> WBTC from their collateral using the <code class="language-plaintext highlighter-rouge">redeemedUnderlying</code> function. However, instead of burning 1.99999999 wei of hWBTC, only 1 wei of hWBTC was burned due to a rounding error. At this point, the attacker was able to withdraw almost all of their collateral tokens, despite having an outstanding loan worth 70 WBTC, because the protocol still thinks that their remaining 1 wei of hWBTC is still worth 250 WBTC which covered their active loan.</p>

    <table>
      <thead>
        <tr>
          <th>State</th>
          <th>Before</th>
          <th>After</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">Attacker shares</code></td>
          <td>2 Wei</td>
          <td>1 Wei</td>
        </tr>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">Attacker collateral</code></td>
          <td>500.00000001 WBTC</td>
          <td>2 wei WBTC</td>
        </tr>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">Exchange Rate</code></td>
          <td>250 WBTC / 1 wei hWBTC</td>
          <td>1 wei WBTC / 1 wei hWBTC</td>
        </tr>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">Loan Value</code></td>
          <td>70  WBTC</td>
          <td>70  WBTC</td>
        </tr>
      </tbody>
    </table>

    <p><br />
 <img class="img img-responsive" alt="pong-almost-from-scratch" height="600" width="500" style="display: block; margin: 0 auto" src="/assets/img/h4.png" />
 <br /></p>
  </li>
  <li>At this point, the attacker’s borrowing position is fully underwater, and they ran away with 70 WBTC worth of ether.</li>
</ol>

<p><br /></p>

<h2 id="how-compound-v2-forks-can-avoid-this-issue">How compound v2 forks can avoid this issue?</h2>
<p><br /></p>

<ul>
  <li>
    <p>If your protocol is already on-chain, ensure that your markets never reach a zero liquidity state by minting a small amount of shares and sending them to the zero address.
<br /></p>
  </li>
  <li>
    <p>When listing a new collateral token, first set its collateral factor to zero, then mint some shares, send them to the zero address, then change the collateral factor to the desired value.</p>
  </li>
</ul>

<p><br /></p>

<p>Happy Hunting Anon!</p>


</article>

        </div>
        <div class="col-sm-2">
          <div class="pane-separator hidden-xs" style="margin-bottom:30em;"></div>
          <div class="pane-separator visible-xs" style="margin-bottom:5em;"></div>
          <div class="right-pane" style="margin-left: 1em;">
            
              <div class="avatar">
                <center>
                  
                    <img src="/assets/img/gitcat.jpg" alt="me" class="avatar-image">
                  
                  
                    <p class="avatar-description">I'm Vijay . I enjoy breaking things</p>
                  
                  <div class="right-links">
                    
<a href="https://github.com/0xvj" target="_blank">
  <i class="fa fa-github fa-3x"></i>
</a>


<a href="mailto:0xvj.alpha@gmail.com">
  <i class="fa fa-envelope fa-3x"></i>
</a>



<a href="https://twitter.com/0xVijayReddy" target="_blank">
  <i class="fa fa-twitter fa-3x"></i>
</a>


<a href="https://www.linkedin.com/in/0xvj" target="_blank">
  <i class="fa fa-linkedin fa-3x"></i>
</a>


                  </div>
                </center>
              </div>
            
            
              <div class="posts-list">
                <a href="/blog">
                  <h4>Recent Posts:</h4>
                </a>
                <ul>
                  
                </ul>
              </div>
            
          </div>
        </div>
      </div>
    </section>
    <section class="footer">
      <footer class="page-footer">
  <center>
    
    <div class="row">
      <div class="col-sm-8 col-sm-offset-2">
        <a onclick="toggleTheme();">
          Light/Dark
        </a>
      </div>
    </div>
    
    <div class="row">
      <div class="col-sm-8 col-sm-offset-2">
        
<a href="https://github.com/0xvj" target="_blank">
  <i class="fa fa-github fa-3x"></i>
</a>


<a href="mailto:0xvj.alpha@gmail.com">
  <i class="fa fa-envelope fa-3x"></i>
</a>



<a href="https://twitter.com/0xVijayReddy" target="_blank">
  <i class="fa fa-twitter fa-3x"></i>
</a>


<a href="https://www.linkedin.com/in/0xvj" target="_blank">
  <i class="fa fa-linkedin fa-3x"></i>
</a>


      </div>
    </div>
    
    <div class="row">
      <div class="col-sm-8 col-sm-offset-2">
        Copyright (c) 2024 0xvj -
        <a href="mailto:0xvj.alpha@gmail.com">&lt;0xvj.alpha@gmail.com&gt;</a>
      </div>
    </div>
    
  </center>
</footer>

    </section>
  </div>
</body>

</html>
